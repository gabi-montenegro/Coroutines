local printLines = coroutine.create(function ()
    while true do
        local line = coroutine.yield()
        print(line)
    end
end)

local numberLines = coroutine.create(function ()
    local lineNo = 1
    while true do
        local line = coroutine.yield()
        coroutine.resume(printLines, string.format("%d: %s", lineNo, line))
        lineNo = lineNo + 1
    end
end)

local splitLines = coroutine.create(function ()
    local previous = ""
    while true do
        local chunk = coroutine.yield()
        if not chunk then break end
        previous = previous .. chunk
        while true do
            local lineEnd = string.find(previous, "\n", 1, true)
            if not lineEnd then break end

            local line = string.sub(previous, 1, lineEnd - 1)
            previous = string.sub(previous, lineEnd + 1)

            coroutine.resume(numberLines, line)

        end
    end
    if #previous > 0 then
        coroutine.resume(numberLines, previous)
    end
end)

function readFile(fileName, chunkSize)
    local file = io.open(fileName, "rb")
    while true do
        local chunk = file:read(chunkSize)
        if not chunk then break end
        coroutine.resume(splitLines, chunk)
    end
    file:close()

    coroutine.resume(splitLines, nil) 

    coroutine.close(splitLines)
    coroutine.close(numberLines)
    coroutine.close(printLines)
end

function activateCoroutines()
    coroutine.resume(splitLines)
    coroutine.resume(numberLines)
    coroutine.resume(printLines)
end

local fileName = arg[1]
activateCoroutines()
readFile(fileName, 16)